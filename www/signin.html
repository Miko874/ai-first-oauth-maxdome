<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>maxdome</title>

  <link href="vendor/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="vendor/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet">

  <style>
    body {
      padding-top: 40px;
      padding-bottom: 40px;
      background-color: #eee;
    }

    .form-signin {
      max-width: 330px;
      padding: 15px;
      margin: 0 auto;
    }

    .form-signin .form-signin-heading,
    .form-signin {
      margin-bottom: 10px;
    }

    .form-signin .checkbox {
      font-weight: normal;
    }

    .form-signin .form-control {
      position: relative;
      height: auto;
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
      padding: 10px;
      font-size: 16px;
    }

    .form-signin .form-control:focus {
      z-index: 2;
    }

    .form-signin input[type="email"] {
      margin-bottom: -1px;
      border-bottom-right-radius: 0;
      border-bottom-left-radius: 0;
    }

    .form-signin input[type="password"] {
      margin-bottom: 10px;
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }
  </style>
</head>
<body>

<div class="container">
  <form id="formSignin" method="post" action="/signin" class="form-signin">
    <h2 class="form-signin-heading">maxdome</h2>
    <label for="inputEmail" class="sr-only">E-Mail</label>
    <input type="email" id="inputEmail" name="email" class="form-control" placeholder="E-Mail" required autofocus>
    <label for="inputPassword" class="sr-only">Passwort</label>
    <input type="password" id="inputPassword" name="password" class="form-control" placeholder="Passwort" required>
    <button class="btn btn-lg btn-primary btn-block" type="submit">Authorisieren</button>
    <span id="helpBlock" class="help-block hidden"></span>
  </form>
  <pre id="search" class="hidden"></pre>
  <pre id="debug" class="hidden"></pre>
</div>

<script src="vendor/jquery/dist/jquery.min.js"></script>
<script src="vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="vendor/urijs/src/URI.min.js"></script>

<script>
  function formHandler(formElement) {
    formElement = $(formElement);
    var eventEmitter = {
      on: function (name, handler) {
        this[name] = this[name] || [];
        this[name].push(handler);
        return this;
      },
      trigger: function (name, event) {
        if (this[name]) {
          this[name].map(function (handler) {
            handler(event);
          });
        }
        return this;
      }
    };
    var submitElement = formElement.find('input[type=submit]');
    var inputElements = formElement.find('input, select');
    formElement.submit(function (event) {
      event.preventDefault();
      var formData = {};
      $.each(inputElements, function (_, element) {
        element = $(element);
        var name = element.attr('name');
        if (name) {
          formData[name] = element.val();
        }
      });
      submitElement.attr('disabled', 'disabled');
      formElement.removeClass('has-error');
      eventEmitter.trigger('submit');
      $[formElement.attr('method')](formElement.attr('action'), formData)
        .always(function () {
          submitElement.removeAttr('disabled', 'disabled');
        })
        .done(function (data) {
          eventEmitter.trigger('done', data);
        })
        .fail(function (jqXHR) {
          formElement.addClass('has-error');
          eventEmitter.trigger('fail', jqXHR);
        });
    });
    return eventEmitter;
  }

  $(function () {
    var search = URI().search(true);

    if (search.debug !== undefined) {
      var element = $('#search');
      element
        .text(JSON.stringify(search, null, 4))
        .removeClass();
      if (search.redirect_uri && search.state) {
        element.addClass('bg-success');
      } else {
        element.addClass('bg-warning');
      }
    }

    var eventEmitter = formHandler('#formSignin');

    eventEmitter
      .on('submit', function () {
        $('#helpBlock').addClass('hidden');
      })
      .on('fail', function (jqXHR) {
        let text;
        if (jqXHR.status === 403) {
          text = 'E-Mail oder Passwort falsch.';
        } else {
          text = 'Unbekannter Fehler, bitte versuchen Sie es sp√§ter nochmal.';
        }
        $('#helpBlock')
          .text(text)
          .removeClass('hidden');
      });

    if (search.redirect_uri && search.state) {
      eventEmitter
        .on('done', function (data) {
          var hash = URI('')
            .search({
              state: search.state,
              access_token: data.accessToken,
              token_type: 'Bearer'
            })
            .query();
          var location = URI(search.redirect_uri).hash(hash).toString();
          window.location = location;
        });
    }

    if (search.debug !== undefined) {
      function debug(text, context) {
        if (search.debug === undefined) {
          return;
        }
        var debugElement = $('#debug');
        debugElement.removeClass();
        if (context) {
          debugElement.addClass('bg-' + context);
        }
        if (typeof text === 'object') {
          text = JSON.stringify(text, null, 4);
        }
        debugElement.text(text);
      }
      eventEmitter
        .on('submit', function () {
          debug('...');
        })
        .on('done', function (data) {
          var accessToken = data.accessToken;
          $.post('/linkedAccount', { accessToken: accessToken })
            .done(function (data) {
              debug({ accessToken: accessToken, linkedAccount: data.linkedAccount }, 'success');
            });
        })
        .on('fail', function (jqXHR) {
          debug(jqXHR.responseText, 'danger');
        });
    }
  });
</script>
</body>
</html>
